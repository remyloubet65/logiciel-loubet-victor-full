<!doctype html>
<html lang="fr">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PFV ‚Äî Dossiers (REST)</title>
<style>
  body{font-family:system-ui,Arial;margin:24px;max-width:900px}
  .box{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
  .ok{color:#13721e}.err{color:#b00020}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #eee;padding:6px;text-align:left}
  input,button{padding:8px;border-radius:8px;border:1px solid #ccc}
  button{background:#f7f7f7;cursor:pointer}
</style>

<h1>PF Loubet-Victor ‚Äî Dossiers (REST)</h1>
<div class="box"><b>Connexion :</b> <span id="s">‚è≥</span></div>

<div class="box">
  <h3>Ajouter un d√©funt</h3>
  <div><input id="nom" placeholder="Nom"></div>
  <div><input id="prenom" placeholder="Pr√©nom"></div>
  <div><input id="dod" type="date" placeholder="Date de d√©c√®s"></div>
  <button id="save">üíæ Enregistrer</button>
</div>

<div class="box">
  <div style="display:flex;gap:8px;align-items:center">
    <h3 style="margin:0">Liste</h3>
    <button id="reload">üîÑ Recharger</button>
  </div>
  <div id="list"></div>
</div>

<script>
const URL = "https://aoidadxujanyxpxctbyvb.supabase.co";
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvaWRhZHh1amFueHB4Y3RieXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDYyNzYsImV4cCI6MjA3NDg4MjI3Nn0.Iaf6J_KzUzRNddUE6Mq6xTJW0xKc7eR6FU3OtW2CwHw";
const s = document.getElementById('s');
const list = document.getElementById('list');

const headers = {
  'apikey': KEY,
  'Authorization': 'Bearer ' + KEY,
  'Content-Type': 'application/json',
  'Prefer': 'return=representation'
};

async function ping(){
  try{
    const r = await fetch(URL + '/rest/v1/decedents?select=id&limit=1', { headers });
    s.innerHTML = r.ok ? '<span class="ok">‚úÖ OK</span>' : '<span class="err">‚ùå HTTP '+r.status+'</span>';
  }catch(e){ s.innerHTML = '<span class="err">‚ùå '+(e.message||e)+'</span>'; }
}

async function load(){
  try{
    const r = await fetch(URL + '/rest/v1/decedents?select=*&order=created_at.desc', { headers });
    if(!r.ok){ list.innerHTML = '<span class="err">Erreur '+r.status+'</span>'; return; }
    const rows = await r.json();
    let html = '<table><thead><tr><th>Nom</th><th>Pr√©nom</th><th>Date d√©c√®s</th><th>Cr√©√© le</th></tr></thead><tbody>';
    rows.forEach(d=>{
      html += '<tr><td>'+ (d.lastname||'') +'</td><td>'+ (d.firstname||'') +'</td><td>'+ (d.date_of_death||'') +'</td><td>'+ new Date(d.created_at).toLocaleString() +'</td></tr>';
    });
    html += '</tbody></table>';
    list.innerHTML = html;
  }catch(e){
    list.innerHTML = '<span class="err">‚ùå '+(e.message||e)+'</span>';
  }
}

async function save(){
  const nom = document.getElementById('nom').value.trim();
  const prenom = document.getElementById('prenom').value.trim();
  const dod = document.getElementById('dod').value || null;
  if(!nom || !prenom){ alert('Nom et pr√©nom obligatoires'); return; }
  const r = await fetch(URL + '/rest/v1/decedents', {
    method: 'POST',
    headers,
    body: JSON.stringify({ lastname: nom, firstname: prenom, date_of_death: dod })
  });
  if(!r.ok){ const t = await r.text(); alert('Erreur '+r.status+': '+t); return; }
  document.getElementById('nom').value = '';
  document.getElementById('prenom').value = '';
  document.getElementById('dod').value = '';
  load();
}

document.getElementById('reload').onclick = load;
document.getElementById('save').onclick = save;

ping();
load();
</script>
</html>
