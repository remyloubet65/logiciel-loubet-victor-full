<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const statusEl = document.getElementById('status');
function setStatus(m){ statusEl.textContent = m; }

setStatus('✅ Prêt (clé anonyme)');

async function render(data){
  const rows = (data||[]).map(d=>`<tr>
    <td>${d.lastname}</td><td>${d.firstname}</td><td>${d.date_of_death||""}</td>
    <td>${new Date(d.created_at).toLocaleString()}</td></tr>`).join('');
  document.getElementById('results').innerHTML =
    `<table><thead><tr><th>Nom</th><th>Prénom</th><th>Date décès</th><th>Créé le</th></tr></thead><tbody>${rows}</tbody></table>` +
    (data?.length? "": "<div style='color:#666;margin-top:8px'>Aucun enregistrement.</div>");
}

async function list(q=""){
  const ilike = q ? `%${q}%` : "%";
  const { data, error } = await sb
    .from('decedents')
    .select('*')
    .or(`lastname.ilike.${ilike},firstname.ilike.${ilike}`)
    .order('created_at',{ascending:false})
    .limit(50);
  if(error){ alert("Erreur SELECT: "+error.message); return; }
  await render(data);
}

document.getElementById('f-add').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const lastname = document.getElementById('lastname').value.trim();
  const firstname = document.getElementById('firstname').value.trim();
  const dod = document.getElementById('dod').value || null;
  const { error } = await sb.from('decedents').insert([{ lastname, firstname, date_of_death: dod }]);
  if(error){ alert("Erreur INSERT: "+error.message); return; }
  e.target.reset();
  await list(""); // rafraîchit
});

document.getElementById('b-search').addEventListener('click', (e)=>{
  e.preventDefault();
  list(document.getElementById('q').value.trim());
});

// Afficher tout au chargement
list("");
</script>
