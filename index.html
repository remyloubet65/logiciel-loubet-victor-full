<!doctype html>
<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>PF Loubet-Victor ‚Äî MVP</title>
<style>
 body{font-family:system-ui,Arial;margin:24px;max-width:1100px}
 h1{margin:0 0 12px}
 .tabs{display:flex;gap:8px;margin:12px 0}
 .tabs button{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
 .tabs button.active{background:#eef7ee;border-color:#9dd39d}
 .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;background:#fff}
 label{display:block;margin:8px 0 4px}
 input,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
 table{width:100%;border-collapse:collapse;margin-top:10px}
 th,td{border:1px solid #eee;padding:8px;text-align:left}
 .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
 .grid-3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px}
 .right{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
 .btn{padding:8px 12px;border:0;border-radius:10px;background:#4b3b8f;color:#fff;cursor:pointer}
 .btn.gray{background:#888}.muted{color:#666;font-size:12px}
</style>
</head><body>
<h1>PF Loubet-Victor ‚Äî MVP</h1>
<div class="card"><strong>Connexion Supabase</strong> <span id="status">‚è≥ Initialisation‚Ä¶</span></div>

<div class="tabs">
  <button id="tab-dossiers" class="active">üìÅ Dossiers</button>
  <button id="tab-tarifs">üí∂ Tarifs</button>
  <button id="tab-devis">üßæ Devis</button>
</div>

<!-- DOSSIERS -->
<div id="pane-dossiers" class="card">
  <h2>Ajouter un d√©funt</h2>
  <div class="row">
    <div><label>Nom</label><input id="lastname"></div>
    <div><label>Pr√©nom</label><input id="firstname"></div>
  </div>
  <label>Date de d√©c√®s</label><input id="dod" type="date">
  <div style="margin-top:12px"><button id="btn-save" class="btn">Enregistrer</button></div>

  <h2 style="margin-top:18px">Recherche</h2>
  <input id="q" placeholder="Nom ou pr√©nom‚Ä¶">
  <div class="right" style="margin-top:8px"><button id="btn-search" class="btn gray">Rechercher</button></div>
  <div id="results"></div>
</div>

<!-- TARIFS -->
<div id="pane-tarifs" class="card" style="display:none">
  <div class="right"><button id="p-add" class="btn">‚ûï Ajouter une prestation</button></div>
  <table id="p-table"><thead><tr><th>Libell√©</th><th>Prix (‚Ç¨)</th><th></th></tr></thead><tbody></tbody></table>
  <div class="muted">Ces prestations servent √† composer les devis.</div>
</div>

<!-- DEVIS -->
<div id="pane-devis" class="card" style="display:none">
  <div class="row">
    <div><label>Client / Famille</label><input id="dv-client" placeholder="Famille DUPONT"></div>
    <div><label>R√©f√©rence</label><input id="dv-ref" placeholder="DEV-2025-0001"></div>
  </div>
  <h3 style="margin-top:12px">Lignes</h3>
  <div class="grid-3">
    <select id="dv-presta"></select>
    <input id="dv-qte" type="number" min="1" value="1">
    <input id="dv-pu" type="number" min="0" step="0.01" placeholder="Prix unitaire">
  </div>
  <div class="right" style="margin-top:8px"><button id="dv-add" class="btn">Ajouter la ligne</button></div>
  <table id="dv-table" style="margin-top:8px"><thead><tr><th>Libell√©</th><th>Qt√©</th><th>PU</th><th>Total</th><th></th></tr></thead><tbody></tbody></table>
  <div class="right" style="margin-top:8px"><strong>Total : <span id="dv-total">0 ‚Ç¨</span></strong></div>
  <div class="right" style="margin-top:12px"><button id="dv-save" class="btn">üíæ Enregistrer le devis</button></div>
  <h3 style="margin-top:18px">Devis enregistr√©s</h3>
  <div id="dv-list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const statusEl = document.getElementById('status');
const setStatus = t => statusEl.textContent = t;
const ‚Ç¨ = n => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(Number(n)||0);

// ‚¨áÔ∏è REMPLACE ICI
const SUPABASE_URL ="https://aoidadxujanxpxctbyvb.supabase.co";
const SUPABASE_ANON_KEY ="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvaWRhZHh1amFueHB4Y3RieXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDYyNzYsImV4cCI6MjA3NDg4MjI3Nn0.Iaf6J_KzUzRNddUE6Mq6xTJW0xKc7eR6FU3OtW2CwHw";

let sb;
try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }
catch(e){ setStatus("‚ùå "+(e.message||e)); throw e; }

(async ()=>{
  // Ping
  const ping = await sb.from('decedents').select('id').limit(1);
  if (ping.error){ setStatus("‚ùå "+ping.error.message); return; }
  setStatus("‚úÖ Pr√™t (cl√© anonyme)");

  // Onglets
  const panes={ dossiers:'pane-dossiers', tarifs:'pane-tarifs', devis:'pane-devis' };
  function show(id){ for(const k in panes){
    document.getElementById(panes[k]).style.display = (k===id?'block':'none');
    document.getElementById('tab-'+k).classList.toggle('active', k===id);
  }}
  document.getElementById('tab-dossiers').onclick=()=>show('dossiers');
  document.getElementById('tab-tarifs').onclick =()=>{ show('tarifs'); loadPrestations(); };
  document.getElementById('tab-devis').onclick  =()=>{ show('devis'); loadPrestationsIntoSelect(); listDevis(); };

  // Dossiers
  async function listDecedents(q=""){
    const ilike=q?`%${q}%`:"%";
    const {data,error}=await sb.from('decedents').select('*')
      .or(`lastname.ilike.${ilike},firstname.ilike.${ilike}`)
      .order('created_at',{ascending:false}).limit(50);
    if(error){ alert(error.message); return; }
    const rows=(data||[]).map(d=>`<tr><td>${d.lastname}</td><td>${d.firstname}</td><td>${d.date_of_death||''}</td><td>${new Date(d.created_at).toLocaleString()}</td></tr>`).join('');
    document.getElementById('results').innerHTML=`<table><thead><tr><th>Nom</th><th>Pr√©nom</th><th>Date d√©c√®s</th><th>Cr√©√© le</th></tr></thead><tbody>${rows}</tbody></table>`;
  }
  document.getElementById('btn-save').onclick=async()=>{
    const lastname=document.getElementById('lastname').value.trim();
    const firstname=document.getElementById('firstname').value.trim();
    const dod=document.getElementById('dod').value||null;
    if(!lastname||!firstname){ alert("Nom/Pr√©nom requis"); return; }
    const ins=await sb.from('decedents').insert([{lastname,firstname,date_of_death:dod}]);
    if(ins.error){ alert(ins.error.message); return; }
    document.getElementById('lastname').value=''; document.getElementById('firstname').value=''; document.getElementById('dod').value='';
    listDecedents("");
  };
  document.getElementById('btn-search').onclick=()=>listDecedents(document.getElementById('q').value.trim());
  listDecedents("");

  // Tarifs
  async function loadPrestations(){
    const {data,error}=await sb.from('prestations').select('*').order('id',{ascending:false});
    if(error){ alert(error.message); return; }
    const tbody=document.querySelector('#p-table tbody');
    tbody.innerHTML=(data||[]).map(p=>`
      <tr>
        <td><input value="${p.nom||''}" data-id="${p.id}" data-k="nom"></td>
        <td><input type="number" step="0.01" value="${p.prix||0}" data-id="${p.id}" data-k="prix"></td>
        <td><button data-del="${p.id}" class="btn gray">Supprimer</button></td>
      </tr>`).join('');
    tbody.querySelectorAll('input').forEach(inp=>{
      inp.onchange=async()=>{
        const id=Number(inp.dataset.id), k=inp.dataset.k, v=(k==='prix'?Number(inp.value):inp.value);
        const {error}=await sb.from('prestations').update({[k]:v}).eq('id',id);
        if(error) alert(error.message);
      };
    });
    tbody.querySelectorAll('button[data-del]').forEach(b=>{
      b.onclick=async()=>{ const id=Number(b.dataset.del); await sb.from('prestations').delete().eq('id',id); loadPrestations(); };
    });
  }
  document.getElementById('p-add').onclick=async()=>{
    const {error}=await sb.from('prestations').insert({nom:'',prix:0});
    if(error){ alert(error.message); return; }
    loadPrestations();
  };

  // Devis
  let dvLines=[];
  function renderDevisLines(){
    const tbody=document.querySelector('#dv-table tbody');
    tbody.innerHTML=dvLines.map((l,i)=>`
      <tr><td>${l.libelle}</td><td>${l.qte}</td><td>${‚Ç¨(l.pu)}</td><td>${‚Ç¨(l.qte*l.pu)}</td>
      <td><button class="btn gray" data-i="${i}">Retirer</button></td></tr>`).join('');
    tbody.querySelectorAll('button[data-i]').forEach(b=>{
      b.onclick=()=>{ dvLines.splice(Number(b.dataset.i),1); renderDevisLines(); };
    });
    const total=dvLines.reduce((s,l)=>s+Number(l.qte)*Number(l.pu),0);
    document.getElementById('dv-total').textContent=‚Ç¨(total);
  }
  async function loadPrestationsIntoSelect(){
    const {data}=await sb.from('prestations').select('*').order('nom');
    const sel=document.getElementById('dv-presta'); sel.innerHTML='';
    (data||[]).forEach(p=>{ const o=document.createElement('option'); o.value=JSON.stringify(p); o.textContent=`${p.nom} ‚Äî ${‚Ç¨(p.prix)}`; sel.appendChild(o); });
  }
  document.getElementById('dv-add').onclick=()=>{
    const p=JSON.parse(document.getElementById('dv-presta').value||'{}');
    const qte=Number(document.getElementById('dv-qte').value||1);
    const pu=Number(document.getElementById('dv-pu').value||p.prix||0);
    if(!p.nom){ alert("Choisis une prestation"); return; }
    dvLines.push({libelle:p.nom,qte,pu}); renderDevisLines();
  };
  document.getElementById('dv-save').onclick=async()=>{
    const client=document.getElementById('dv-client').value.trim();
    const ref=(document.getElementById('dv-ref').value.trim()) || `DEV-${new Date().getFullYear()}-${Date.now().toString().slice(-4)}`;
    if(!client){ alert("Client requis"); return; }
    if(dvLines.length===0){ alert("Ajoute au moins une ligne"); return; }
    const {data:dv,error}=await sb.from('devis').insert({ref,client}).select().single();
    if(error){ alert(error.message); return; }
    const lines=dvLines.map(l=>({devis_id:dv.id,libelle:l.libelle,qte:l.qte,pu:l.pu}));
    const ins=await sb.from('devis_lignes').insert(lines);
    if(ins.error){ alert(ins.error.message); return; }
    dvLines=[]; renderDevisLines(); document.getElementById('dv-client').value=''; document.getElementById('dv-ref').value='';
    listDevis();
  };
  async function listDevis(){
    const wrap=document.getElementById('dv-list');
    const {data:ds,error}=await sb.from('devis').select('id,ref,client,created_at').order('id',{ascending:false}).limit(50);
    if(error){ alert(error.message); return; }
    wrap.innerHTML=(ds||[]).map(d=>`<div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div><strong>${d.ref}</strong><div class="muted">${d.client} ‚Äî ${new Date(d.created_at).toLocaleString()}</div></div>
        <button class="btn gray" data-open="${d.id}">Voir</button>
      </div>
      <div id="dv-view-${d.id}" style="display:none;margin-top:8px"></div>
    </div>`).join('');
    wrap.querySelectorAll('button[data-open]').forEach(b=>{
      b.onclick=async()=>{
        const id=Number(b.dataset.open);
        const {data:lg}=await sb.from('devis_lignes').select('*').eq('devis_id',id);
        const total=(lg||[]).reduce((s,l)=>s+Number(l.qte)*Number(l.pu),0);
        const el=document.getElementById('dv-view-'+id);
        el.style.display=el.style.display==='none'?'block':'none';
        el.innerHTML=`<table><thead><tr><th>Libell√©</th><th>Qt√©</th><th>PU</th><th>Total</th></tr></thead><tbody>${
          (lg||[]).map(l=>`<tr><td>${l.libelle}</td><td>${l.qte}</td><td>${‚Ç¨(l.pu)}</td><td>${‚Ç¨(l.qte*l.pu)}</td></tr>`).join('')
        }</tbody></table><div class="right" style="margin-top:8px"><strong>Total : ${‚Ç¨(total)}</strong></div>`;
      };
    });
  }
})();
</script>
</body></html>
