<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PFV — Test REST + Client</title>
<style>
  body{font-family:system-ui,Arial;margin:24px;max-width:900px}
  .box{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
  pre{background:#f7f7f7;padding:12px;border-radius:8px;white-space:pre-wrap}
  .ok{color:#13721e}.err{color:#b00020}
</style>

<h1>PFV — Diagnostic réseau</h1>

<div class="box">
  <b>1) REST direct</b> → <span id="r1">⏳</span>
  <pre id="o1"></pre>
</div>

<div class="box">
  <b>2) Client supabase-js</b> → <span id="r2">⏳</span>
  <pre id="o2"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
<script>
  const URL = "https://aoidadxujanyxpxctbyvb.supabase.co";
  const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvaWRhZHh1amFueHB4Y3RieXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMDYyNzYsImV4cCI6MjA3NDg4MjI3Nn0.Iaf6J_KzUzRNddUE6Mq6xTJW0xKc7eR6FU3OtW2CwHw";

  // --- Test 1: REST direct (devrait retourner des données ou erreur JSON lisible)
  (async () => {
    try {
      const resp = await fetch(URL + "/rest/v1/decedents?select=id&limit=1", {
        headers: { apikey: KEY, Authorization: "Bearer " + KEY }
      });
      const text = await resp.text();
      document.getElementById("r1").innerHTML = resp.ok ? '<span class="ok">OK</span>' : '<span class="err">HTTP '+resp.status+'</span>';
      document.getElementById("o1").textContent = text || "(vide)";
    } catch (e) {
      document.getElementById("r1").innerHTML = '<span class="err">FAILED</span>';
      document.getElementById("o1").textContent = (e && e.message) ? e.message : String(e);
    }
  })();

  // --- Test 2: client supabase-js
  (async () => {
    try {
      const sb = window.supabase.createClient(URL, KEY);
      const { data, error } = await sb.from('decedents').select('id').limit(1);
      if (error) {
        document.getElementById("r2").innerHTML = '<span class="err">ERROR</span>';
        document.getElementById("o2").textContent = JSON.stringify(error, null, 2);
      } else {
        document.getElementById("r2").innerHTML = '<span class="ok">OK</span>';
        document.getElementById("o2").textContent = JSON.stringify(data, null, 2);
      }
    } catch (e) {
      document.getElementById("r2").innerHTML = '<span class="err">FAILED</span>';
      document.getElementById("o2").textContent = (e && e.message) ? e.message : String(e);
    }
  })();
</script>
